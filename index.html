<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>School Results Portal</title>
  <!-- CloudKit JS (Apple iCloud) -->
  <script src="https://cdn.apple-cloudkit.com/ck/2/cloudkit.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
        body {
            box-sizing: border-box;
        }

        .dynamic-bg {
            background: linear-gradient(45deg, #667eea, #764ba2, #f093fb, #f5576c, #4facfe, #00f2fe);
            background-size: 400% 400%;
            animation: gradientShift 8s ease infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="dynamic-bg min-h-full">
  <div class="min-h-full flex flex-col"><!-- Header -->
   <header class="glass-effect p-6">
    <div class="max-w-6xl mx-auto flex flex-col items-center gap-2">
     <h1 id="school-name" class="text-3xl font-bold text-white text-center">NEJO SPECIAL BOARDING SCHOOL</h1>
     <p id="welcome-message" class="text-white/80 text-center mt-2">Welcome to our Student Results Portal</p>
    </div>
   </header><!-- Main Content -->
   <main class="flex-1 p-6">
    <div class="max-w-4xl mx-auto"><!-- Home Page -->
     <div id="home-page" class="space-y-8">
      <div class="text-center mb-8">
       <h2 class="text-4xl font-bold text-white mb-4">Student Results Management System</h2>
       <p class="text-white/90 text-lg">Secure portal for students and teachers</p>
       <div class="mt-4">
         <button onclick="seedDemoAndOpenTeacher()" class="bg-yellow-500 hover:bg-yellow-600 text-black px-4 py-2 rounded-md font-semibold mr-2">Run Demo</button>
         <button onclick="showHome()" class="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-md font-medium">Reset</button>
       </div>
      </div>
      <div class="grid md:grid-cols-2 gap-8"><!-- Student Portal -->
       <div class="glass-effect rounded-xl p-8 text-center">
        <div class="text-6xl mb-4">
         üéì
        </div>
        <h3 class="text-2xl font-bold text-white mb-4">Student Portal</h3>
        <p class="text-white/80 mb-6">Check your exam results and academic progress</p><button onclick="showStudentLogin()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-semibold transition-colors w-full"> Student Login </button>
       </div><!-- Teacher Portal -->
       <div class="glass-effect rounded-xl p-8 text-center">
        <div class="text-6xl mb-4">
         üë®‚Äçüè´
        </div>
        <h3 class="text-2xl font-bold text-white mb-4">Teacher Portal</h3>
        <p class="text-white/80 mb-6">Upload and manage student results</p><button onclick="showTeacherLogin()" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-semibold transition-colors w-full"> Teacher Login </button>
       </div>
      </div>
     </div><!-- Student Login Page -->
     <div id="student-login-page" class="hidden">
      <div class="max-w-md mx-auto glass-effect rounded-xl p-8">
       <div class="text-center mb-6">
        <div class="text-5xl mb-4">
         üéì
        </div>
        <h2 class="text-2xl font-bold text-white">Student Login</h2>
       </div>
       <div id="student-login-form">
        <div class="space-y-4">
         <div><label for="student-id-login" class="block text-white font-medium mb-2">Student ID</label> <input type="text" id="student-id-login" class="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/60" placeholder="Enter your Student ID">
         </div>
         <div><label for="student-password-login" class="block text-white font-medium mb-2">Password</label> <input type="password" id="student-password-login" class="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/60" placeholder="Enter your password">
         </div><button onclick="loginStudent()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold transition-colors"> Login </button>
         <div class="text-center"><button onclick="showStudentRegister()" class="text-white/80 hover:text-white underline"> Don't have an account? Register here </button>
         </div>
        </div>
       </div>
       <div id="student-register-form" class="hidden">
        <div class="space-y-4">
         <div><label for="student-name-register" class="block text-white font-medium mb-2">Full Name</label> <input type="text" id="student-name-register" class="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/60" placeholder="Enter your full name">
         </div>
         <div><label for="student-id-register" class="block text-white font-medium mb-2">Student ID</label> <input type="text" id="student-id-register" class="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/60" placeholder="Enter your Student ID">
         </div>
         <div><label for="student-password-register" class="block text-white font-medium mb-2">Create Password</label> <input type="password" id="student-password-register" class="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/60" placeholder="Create a password">
         </div><button onclick="registerStudent()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold transition-colors"> Register </button>
         <div class="text-center"><button onclick="showStudentLogin()" class="text-white/80 hover:text-white underline"> Already have an account? Login here </button>
         </div>
        </div>
       </div>
       <div class="text-center mt-6"><button onclick="showHome()" class="text-white/80 hover:text-white underline"> ‚Üê Back to Home </button>
       </div>
      </div>
     </div><!-- Teacher Login Page -->
     <div id="teacher-login-page" class="hidden">
      <div class="max-w-md mx-auto glass-effect rounded-xl p-8">
       <div class="text-center mb-6">
        <div class="text-5xl mb-4">
         üë®‚Äçüè´
        </div>
        <h2 class="text-2xl font-bold text-white">Teacher Login</h2>
       </div>
       <div class="space-y-4">
        <div><label for="teacher-name" class="block text-white font-medium mb-2">Teacher Name</label> <input type="text" id="teacher-name" class="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/60" placeholder="Enter your name">
        </div>
        <div><label for="teacher-password" class="block text-white font-medium mb-2">Password</label> <input type="password" id="teacher-password" class="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/60" placeholder="Enter password">
        </div><button onclick="loginTeacher()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-semibold transition-colors"> Login </button>
       </div>
       <div class="text-center mt-6"><button onclick="showHome()" class="text-white/80 hover:text-white underline"> ‚Üê Back to Home </button>
       </div>
      </div>
     </div><!-- Student Dashboard -->
     <div id="student-dashboard" class="hidden">
      <div class="glass-effect rounded-xl p-8">
       <div class="flex justify-between items-center mb-6">
        <div>
         <h2 class="text-2xl font-bold text-white">Student Dashboard</h2>
         <p id="student-welcome" class="text-white/80">Welcome back!</p>
        </div><button onclick="logoutStudent()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg"> Logout </button>
       </div>
       <div class="bg-white/10 rounded-lg p-6">
        <h3 class="text-xl font-semibold text-white mb-4">Your Results</h3>
        <div id="student-results" class="space-y-3">
         <p class="text-white/80">No results available yet.</p>
        </div>
       </div>
      </div>
     </div><!-- Teacher Dashboard -->
     <div id="teacher-dashboard" class="hidden">
      <div class="glass-effect rounded-xl p-8">
       <div class="flex justify-between items-center mb-6">
        <div>
         <h2 class="text-2xl font-bold text-white">Teacher Dashboard</h2>
         <p id="teacher-welcome" class="text-white/80">Manage student results</p>
        </div><button onclick="logoutTeacher()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg"> Logout </button>
       </div><!-- Upload Results Form -->
       <div class="bg-white/10 rounded-lg p-6 mb-6">
        <h3 class="text-xl font-semibold text-white mb-4">Upload Student Result</h3>
        <div class="grid md:grid-cols-2 gap-4">
         <!-- Grade level selector moved to top (above Student ID) as requested -->
         <div>
           <label for="result-grade-level" class="block text-white font-medium mb-2">Grade Level</label>
           <select id="result-grade-level" class="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/20 text-white">
             <option value="9th">9th</option>
             <option value="10th">10th</option>
             <option value="11th">11th</option>
             <option value="12th">12th</option>
           </select>
         </div>

         <!-- Stream selector (Natural / Social) ‚Äî appears only for 11th or 12th -->
         <div id="result-stream-container" class="hidden">
           <label for="result-stream" class="block text-white font-medium mb-2">Stream</label>
           <select id="result-stream" class="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/20 text-white">
             <option value="">Select stream</option>
             <option value="Natural">Natural</option>
             <option value="Social">Social</option>
           </select>
         </div>

         <div>
           <label for="result-student-id" class="block text-white font-medium mb-2">Student ID</label>
           <input type="text" id="result-student-id" class="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/60" placeholder="Enter Student ID">
         </div>

         <div>
           <label for="result-subject" class="block text-white font-medium mb-2">Subject</label>
           <!-- subject select will be populated by JS based on grade/stream -->
           <select id="result-subject" class="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/20 text-white"></select>
         </div>

         <div><label for="result-score" class="block text-white font-medium mb-2">Score</label> <input type="number" id="result-score" min="0" max="100" class="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/60" placeholder="Enter score (0-100)">
         </div>
         <div><label for="result-status" class="block text-white font-medium mb-2">Status</label> <select id="result-status" class="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/20 text-white"> <option value="Pass" class="bg-gray-800">Pass</option> <option value="Fail" class="bg-gray-800">Fail</option> </select>
         </div>
        </div><button onclick="uploadResult()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors"> Upload Result </button>
       </div><!-- All Results -->
       <div class="bg-white/10 rounded-lg p-6">
        <h3 class="text-xl font-semibold text-white mb-4">All Student Results</h3>
        <div id="all-results" class="space-y-3">
         <p class="text-white/80">No results uploaded yet.</p>
        </div>
       </div>
      </div>
     </div>
    </div>
   </main><!-- Footer -->
   <footer class="glass-effect p-4">
    <div class="max-w-6xl mx-auto text-center">
     <p id="footer-text" class="text-white/80">¬© 2024 School Results Portal - Secure &amp; Reliable</p>
    </div>
   </footer>
  </div>

  <script>
/*
  iCloud (CloudKit JS) Integration

  Summary:
  - This page uses CloudKit JS to persist students and results to an iCloud container
    instead of relying only on localStorage.
  - You must configure a CloudKit container in your Apple Developer account & CloudKit Dashboard,
    enable Web Services and create two record types: "Student" and "Result".
  - For passwords we store a salted SHA-256 hash (client-side) ‚Äî still not ideal for production.
    For production-grade security, move authentication to a proper backend and avoid storing raw
    credentials client-side.

  Setup steps (high level):
  1) Create an Apple developer account & CloudKit container (container ID like iCloud.com.example.school).
  2) In CloudKit Dashboard create two record types:
     - Student with fields: student_id (String, indexed, unique), student_name (String), password_hash (String)
     - Result with fields: student_id (String, indexed), student_name (String), subject (String), score (Number),
       status (String), teacher_name (String), date_uploaded (Date), grade_level (String), stream (String)
  3) Enable Web Services on the container and create a Web Token (or configure allowed origins).
  4) Replace CONTAINER_CONFIG below with your container details (containerIdentifier and environment).
  5) Deploy and test. Use CloudKit Dashboard to view records.

  IMPORTANT:
  - This is a demo integration. Do NOT use it as-is for production authentication.
  - Consider server-side secure handling of passwords, role-based access, and encryption at rest.
*/

const CONTAINER_CONFIG = {
  containerIdentifier: 'iCloud.com.example.school', // <-- replace this with your CloudKit container ID
  environment: 'development' // or 'production'
};

// --- initialize CloudKit ---
let cloudkitContainer = null;
function initCloudKit() {
  if (!window.CloudKit) {
    console.warn('CloudKit JS not loaded');
    return;
  }

  CloudKit.configure({
    containers: [{
      containerIdentifier: CONTAINER_CONFIG.containerIdentifier,
      apiToken: {
        // For public web access you can use a web API token from CloudKit Dashboard.
        // Leave blank if you plan to use user tokens via Apple ID sign-in (recommended).
        // apiToken: 'YOUR_WEB_API_TOKEN_IF_USED'
      },
      environment: CONTAINER_CONFIG.environment
    }]
  });
  cloudkitContainer = CloudKit.getDefaultContainer();
  // optional: set up auth UI state
  cloudkitContainer.setUpAuth().then(() => {
    console.info('CloudKit setUpAuth complete');
  }).catch(err => console.warn('setUpAuth failed', err));
}

// Helper: hash a password (SHA-256) via Web Crypto
async function hashPassword(password, salt) {
  const enc = new TextEncoder();
  const data = enc.encode(salt + '|' + password);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

// CloudKit helpers: Students & Results CRUD
async function loadFromCloudKit() {
  if (!cloudkitContainer) { console.warn('CloudKit not initialized'); return; }
  try {
    // load students
    const studentsQuery = { recordType: 'Student', filterBy: [] };
    const studentsRes = await cloudkitContainer.publicCloudDatabase.performQuery(studentsQuery);
    const ckStudents = (studentsRes.records || []).map(r => ({
      student_id: r.fields.student_id.value,
      student_name: r.fields.student_name.value,
      password_hash: r.fields.password_hash ? r.fields.password_hash.value : ''
    }));
    window.students = ckStudents;

    // load results
    const resultsQuery = { recordType: 'Result', filterBy: [] };
    const resultsRes = await cloudkitContainer.publicCloudDatabase.performQuery(resultsQuery);
    const ckResults = (resultsRes.records || []).map(r => ({
      student_id: r.fields.student_id.value,
      student_name: r.fields.student_name.value,
      subject: r.fields.subject.value,
      score: r.fields.score.value,
      status: r.fields.status.value,
      teacher_name: r.fields.teacher_name.value,
      date_uploaded: r.fields.date_uploaded.value,
      grade_level: r.fields.grade_level ? r.fields.grade_level.value : '',
      stream: r.fields.stream ? r.fields.stream.value : ''
    }));

    window.results = ckResults;
    console.info(`Loaded ${window.students.length} students and ${window.results.length} results from CloudKit`);
  } catch (err) {
    console.error('Failed to load from CloudKit', err);
  }
}

async function saveStudentToCloudKit(student) {
  if (!cloudkitContainer) { console.warn('CloudKit not initialized'); return; }
  try {
    // upsert by student_id: do a lookup first
    const lookupRes = await cloudkitContainer.publicCloudDatabase.performQuery({
      recordType: 'Student',
      filterBy: [{
        fieldName: 'student_id',
        comparator: 'EQUALS',
        fieldValue: { value: student.student_id }
      }]
    });

    if ((lookupRes.records || []).length > 0) {
      // update existing
      const rec = lookupRes.records[0];
      rec.fields.student_name = { value: student.student_name };
      rec.fields.password_hash = { value: student.password_hash || '' };
      await cloudkitContainer.publicCloudDatabase.modifyRecords({ records: [rec] });
    } else {
      // create new
      const newRec = {
        recordType: 'Student',
        fields: {
          student_id: { value: student.student_id },
          student_name: { value: student.student_name },
          password_hash: { value: student.password_hash || '' }
        }
      };
      await cloudkitContainer.publicCloudDatabase.saveRecords({ records: [newRec] });
    }
  } catch (err) {
    console.error('Failed to save student to CloudKit', err);
  }
}

async function saveResultToCloudKit(result) {
  if (!cloudkitContainer) { console.warn('CloudKit not initialized'); return; }
  try {
    const newRec = {
      recordType: 'Result',
      fields: {
        student_id: { value: result.student_id },
        student_name: { value: result.student_name },
        subject: { value: result.subject },
        score: { value: result.score },
        status: { value: result.status },
        teacher_name: { value: result.teacher_name },
        date_uploaded: { value: new Date(result.date_uploaded) },
        grade_level: { value: result.grade_level || '' },
        stream: { value: result.stream || '' }
      }
    };
    await cloudkitContainer.publicCloudDatabase.saveRecords({ records: [newRec] });
  } catch (err) {
    console.error('Failed to save result to CloudKit', err);
  }
}

// --- Existing app code (unchanged logic) ---
let students = [];
let results = [];
let currentUser = null;
let currentUserType = null;

const FULL_SUBJECTS = [
  'Mathematics','Biology','English','Physics','Chemistry','Geography','History','Economics',
  'F.Language','Afan Oromo','Amharic','ICT','HPE','Area-Study','Citizenship','Agriculture','CHS'
];

const NATURAL_SUBJECTS = [
  'Mathematics','Biology','English','Physics','Chemistry','F.Language','Afan Oromo','ICT','Area-Study','Agriculture','CHS'
];

const SOCIAL_SUBJECTS = [
  'Mathematics','Biology','English','Geography','History','Economics','F.Language','Afan Oromo','ICT','Area-Study','CHS'
];

const LOWER_SUBJECTS = FULL_SUBJECTS.filter(s => s !== 'CHS' && s !== 'Agriculture');

let SUBJECTS = FULL_SUBJECTS.slice();

function setSubjects(newList) {
    if (!Array.isArray(newList)) return;
    SUBJECTS = newList.slice();
    populateSubjectOptions();
}

function populateSubjectOptions() {
    const sel = document.getElementById('result-subject');
    if (!sel) return;
    const prev = sel.value;
    sel.innerHTML = SUBJECTS.map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join('');
    if (prev && SUBJECTS.includes(prev)) sel.value = prev;
}

function updateSubjectOptionsBasedOnGradeAndStream() {
    const gradeEl = document.getElementById('result-grade-level');
    const streamEl = document.getElementById('result-stream');
    const streamContainer = document.getElementById('result-stream-container');
    if (!gradeEl) return;

    const grade = gradeEl.value;
    if (grade === '11th' || grade === '12th') {
        if (streamContainer) streamContainer.classList.remove('hidden');
        const stream = streamEl ? streamEl.value : '';
        if (stream === 'Natural') {
            setSubjects(NATURAL_SUBJECTS);
        } else if (stream === 'Social') {
            setSubjects(SOCIAL_SUBJECTS);
        } else {
            setSubjects([]);
            const sel = document.getElementById('result-subject');
            if (sel) sel.innerHTML = `<option value="">Select stream first</option>`;
        }
    } else {
        if (streamContainer) streamContainer.classList.add('hidden');
        if (streamEl) streamEl.value = '';
        setSubjects(LOWER_SUBJECTS);
    }
}

// --- Initialization ---
function initializeApp() {
    populateSubjectOptions();

    const gradeSelect = document.getElementById('result-grade-level');
    const streamSelect = document.getElementById('result-stream');

    if (gradeSelect) gradeSelect.addEventListener('change', updateSubjectOptionsBasedOnGradeAndStream);
    if (streamSelect) streamSelect.addEventListener('change', updateSubjectOptionsBasedOnGradeAndStream);

    updateSubjectOptionsBasedOnGradeAndStream();

    // Initialize CloudKit and then load remote data (if configured)
    initCloudKit();
    // attempt to load remote data; if CloudKit not configured correctly this will be a no-op
    loadFromCloudKit().then(() => {
      // If no cloud data present, fall back to local storage load
      loadDataFromLocalStorage();
      // continue app startup
      updateAllResults();
      showHome();
    });

    // load local state into UI (in case cloud failed)
    showHome();
}

function showHome() {
    hideAllPages();
    document.getElementById('home-page').classList.remove('hidden');
    currentUser = null;
    currentUserType = null;
}
function showStudentLogin() {
    hideAllPages();
    document.getElementById('student-login-page').classList.remove('hidden');
    document.getElementById('student-login-form').classList.remove('hidden');
    document.getElementById('student-register-form').classList.add('hidden');
}
function showStudentRegister() {
    document.getElementById('student-login-form').classList.add('hidden');
    document.getElementById('student-register-form').classList.remove('hidden');
}
function showTeacherLogin() {
    hideAllPages();
    document.getElementById('teacher-login-page').classList.remove('hidden');
}
function hideAllPages() {
    ['home-page', 'student-login-page', 'teacher-login-page', 'student-dashboard', 'teacher-dashboard']
        .forEach(page => document.getElementById(page).classList.add('hidden'));
}

// --- Student Registration (now saves to CloudKit) ---
async function registerStudent() {
    const name = document.getElementById('student-name-register').value.trim();
    const studentId = document.getElementById('student-id-register').value.trim();
    const password = document.getElementById('student-password-register').value.trim();
    if (!name || !studentId || !password) {
        showMessage("Please fill in all fields", "error");
        return;
    }
    if (students.some(s => s.student_id === studentId)) {
        showMessage("Student ID already registered", "error");
        return;
    }

    // create salt and hash
    const salt = crypto.getRandomValues(new Uint8Array(12)).join('-');
    const password_hash = await hashPassword(password, salt);

    const studentObj = { student_id: studentId, student_name: name, password_hash: salt + '|' + password_hash };
    students.push(studentObj);

    // persist locally and remotely
    schoolStorage.save();
    await saveStudentToCloudKit(studentObj);

    showMessage("Registration successful! You can now login.", "success");
    showStudentLogin();
    clearForm(['student-name-register', 'student-id-register', 'student-password-register']);
}

// --- Student Login (verifies hash) ---
async function loginStudent() {
    const studentId = document.getElementById('student-id-login').value.trim();
    const password = document.getElementById('student-password-login').value.trim();
    if (!studentId || !password) {
        showMessage("Please enter both Student ID and password", "error");
        return;
    }
    const student = students.find(s => s.student_id === studentId);
    if (!student) {
        showMessage("Invalid Student ID or password", "error");
        return;
    }
    // stored as "salt|hash"
    const [salt, storedHash] = (student.password_hash || '').split('|');
    const tryHash = await hashPassword(password, salt || '');
    if (tryHash === storedHash) {
        currentUser = student;
        currentUserType = 'student';
        document.getElementById('student-welcome').textContent = `Welcome back, ${student.student_name}!`;
        hideAllPages();
        document.getElementById('student-dashboard').classList.remove('hidden');
        updateStudentResults();
        clearForm(['student-id-login', 'student-password-login']);
    } else {
        showMessage("Invalid Student ID or password", "error");
    }
}

// --- Teacher Login ---
function loginTeacher() {
    const teacherName = document.getElementById('teacher-name').value.trim();
    const password = document.getElementById('teacher-password').value.trim();
    if (!teacherName || !password) {
        showMessage("Please enter both name and password", "error");
        return;
    }
    if (password === 'teacher2025') {
        currentUser = { name: teacherName };
        currentUserType = 'teacher';
        document.getElementById('teacher-welcome').textContent = `Welcome, ${teacherName}!`;
        hideAllPages();
        document.getElementById('teacher-dashboard').classList.remove('hidden');
        updateSubjectOptionsBasedOnGradeAndStream();
        updateAllResults();
        clearForm(['teacher-name', 'teacher-password']);
    } else {
        showMessage("Invalid password", "error");
    }
}

// --- Teacher: Upload Result (saves to CloudKit) ---
async function uploadResult() {
    const studentId = document.getElementById('result-student-id').value.trim();
    const subject = document.getElementById('result-subject').value;
    const scoreVal = document.getElementById('result-score').value;
    const score = parseInt(scoreVal);
    const status = document.getElementById('result-status').value;
    const gradeLevel = document.getElementById('result-grade-level') ? document.getElementById('result-grade-level').value : '';
    const stream = document.getElementById('result-stream') ? document.getElementById('result-stream').value : '';

    if (!studentId || !subject || scoreVal === '') {
        showMessage("Please fill in all fields", "error");
        return;
    }
    if (isNaN(score) || score < 0 || score > 100) {
        showMessage("Score must be a number between 0 and 100", "error");
        return;
    }
    if ((gradeLevel === '11th' || gradeLevel === '12th') && !stream) {
        showMessage("Please select a stream (Natural or Social) for 11th/12th", "error");
        return;
    }

    const student = students.find(s => s.student_id === studentId);
    if (!student) {
        showMessage("Student ID does not exist. Please register student first.", "error");
        return;
    }
    const resultObj = {
        student_id: studentId,
        student_name: student.student_name,
        subject,
        score,
        status,
        teacher_name: (currentUser && currentUser.name) ? currentUser.name : 'Unknown',
        date_uploaded: new Date().toISOString(),
        grade_level: gradeLevel,
        stream: stream
    };

    results.push(resultObj);

    // persist local and remote
    schoolStorage.save();
    await saveResultToCloudKit(resultObj);

    showMessage("Result uploaded successfully!", "success");
    clearForm(['result-student-id', 'result-score']);
    document.getElementById('result-status').value = 'Pass';
    updateAllResults();
}

// --- Student Dashboard ---
function updateStudentResults() {
    const resultsContainer = document.getElementById('student-results');
    if (!currentUser || !currentUser.student_id) {
        resultsContainer.innerHTML = '<p class="text-white/80">Please login as a student to view results.</p>';
        return;
    }
    const studentResults = results.filter(r => r.student_id === currentUser.student_id);
    if (studentResults.length === 0) {
        resultsContainer.innerHTML = '<p class="text-white/80">No results available yet.</p>';
        return;
    }

    const gradeOrder = ['9th', '10th', '11th', '12th'];
    const htmlParts = [];

    gradeOrder.forEach(grade => {
        const gradeItems = studentResults.filter(r => r.grade_level === grade);
        htmlParts.push(`<div class="mb-6">`);
        htmlParts.push(`<h4 class="text-lg font-semibold text-white mb-2">${escapeHtml(grade)} Results</h4>`);
        if (gradeItems.length === 0) {
            htmlParts.push(`<p class="text-white/80">No results for ${escapeHtml(grade)}.</p>`);
        } else {
            const includeStream = (grade === '11th' || grade === '12th');
            htmlParts.push(`
              <div class="overflow-x-auto bg-transparent rounded-md">
                <table class="min-w-full text-left">
                  <thead>
                    <tr>
                      <th class="px-4 py-3 text-sm font-semibold text-white">Subject</th>
                      <th class="px-4 py-3 text-sm font-semibold text-white">Score</th>
                      <th class="px-4 py-3 text-sm font-semibold text-white">Status</th>
                      ${includeStream ? '<th class="px-4 py-3 text-sm font-semibold text-white">Stream</th>' : ''}
                      <th class="px-4 py-3 text-sm font-semibold text-white">Date</th>
                      <th class="px-4 py-3 text-sm font-semibold text-white">Teacher</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-white/10">
                    ${gradeItems.slice().sort((a,b) => new Date(b.date_uploaded) - new Date(a.date_uploaded)).map(result => `
                      <tr>
                        <td class="px-4 py-3 text-white/90">${escapeHtml(result.subject)}</td>
                        <td class="px-4 py-3 text-white">${result.score}/100</td>
                        <td class="px-4 py-3">
                          <span class="px-3 py-1 rounded-full text-sm font-semibold ${result.status === 'Pass' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}">
                            ${result.status}
                          </span>
                        </td>
                        ${includeStream ? `<td class="px-4 py-3 text-white/80">${escapeHtml(result.stream || '')}</td>` : ''}
                        <td class="px-4 py-3 text-white/80">${new Date(result.date_uploaded).toLocaleDateString()}</td>
                        <td class="px-4 py-3 text-white/80">${escapeHtml(result.teacher_name)}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            `);

            const total = gradeItems.reduce((s, r) => s + (Number(r.score) || 0), 0);
            const avg = gradeItems.length ? Math.round((total / gradeItems.length) * 100) / 100 : 0;
            htmlParts.push(`
              <div class="mt-3 bg-white/5 rounded-md p-3 flex items-center justify-between">
                <div class="text-white/90">Total Score (${escapeHtml(grade)}): <span class="font-semibold text-white">${total}</span></div>
                <div class="text-white/90">Average: <span class="font-semibold text-white">${avg}/100</span></div>
              </div>
            `);
        }
        htmlParts.push(`</div>`);
    });

    const otherItems = studentResults.filter(r => !gradeOrder.includes(r.grade_level));
    if (otherItems.length) {
        htmlParts.push(`<div class="mb-6">`);
        htmlParts.push(`<h4 class="text-lg font-semibold text-white mb-2">Other / Unspecified Grade Results</h4>`);
        htmlParts.push(`
          <div class="overflow-x-auto">
            <table class="min-w-full text-left">
              <thead>
                <tr>
                  <th class="px-4 py-3 text-sm font-semibold text-white">Subject</th>
                  <th class="px-4 py-3 text-sm font-semibold text-white">Score</th>
                  <th class="px-4 py-3 text-sm font-semibold text-white">Status</th>
                  <th class="px-4 py-3 text-sm font-semibold text-white">Grade</th>
                  <th class="px-4 py-3 text-sm font-semibold text-white">Stream</th>
                  <th class="px-4 py-3 text-sm font-semibold text-white">Date</th>
                  <th class="px-4 py-3 text-sm font-semibold text-white">Teacher</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-white/10">
                ${otherItems.slice().sort((a,b) => new Date(b.date_uploaded) - new Date(a.date_uploaded)).map(result => `
                  <tr>
                    <td class="px-4 py-3 text-white/90">${escapeHtml(result.subject)}</td>
                    <td class="px-4 py-3 text-white">${result.score}/100</td>
                    <td class="px-4 py-3">
                      <span class="px-3 py-1 rounded-full text-sm font-semibold ${result.status === 'Pass' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}">
                        ${result.status}
                      </span>
                    </td>
                    <td class="px-4 py-3 text-white/80">${escapeHtml(result.grade_level || '‚Äî')}</td>
                    <td class="px-4 py-3 text-white/80">${escapeHtml(result.stream || '‚Äî')}</td>
                    <td class="px-4 py-3 text-white/80">${new Date(result.date_uploaded).toLocaleDateString()}</td>
                    <td class="px-4 py-3 text-white/80">${escapeHtml(result.teacher_name)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `);
        const totalOther = otherItems.reduce((s, r) => s + (Number(r.score) || 0), 0);
        const avgOther = otherItems.length ? Math.round((totalOther / otherItems.length) * 100) / 100 : 0;
        htmlParts.push(`
          <div class="mt-3 bg-white/5 rounded-md p-3 flex items-center justify-between">
            <div class="text-white/90">Total Score (Other): <span class="font-semibold text-white">${totalOther}</span></div>
            <div class="text-white/90">Average: <span class="font-semibold text-white">${avgOther}/100</span></div>
          </div>
        `);
        htmlParts.push(`</div>`);
    }

    resultsContainer.innerHTML = htmlParts.join('');
}

// --- Teacher Dashboard ---
function updateAllResults() {
    const resultsContainer = document.getElementById('all-results');
    if (results.length === 0) {
        resultsContainer.innerHTML = '<p class="text-white/80">No results uploaded yet.</p>';
        return;
    }

    const grouped = results.reduce((acc, r) => {
        if (!acc[r.student_id]) {
            acc[r.student_id] = { student_id: r.student_id, student_name: r.student_name, items: [] };
        }
        acc[r.student_id].items.push(r);
        return acc;
    }, {});

    const studentsList = Object.values(grouped);

    resultsContainer.innerHTML = `
      <div class="overflow-x-auto">
        <table class="min-w-full text-left">
          <thead>
            <tr>
              <th class="px-4 py-3 text-sm font-semibold text-white">Student ID</th>
              <th class="px-4 py-3 text-sm font-semibold text-white">Name</th>
              <th class="px-4 py-3 text-sm font-semibold text-white">Grade Level</th>
              <th class="px-4 py-3 text-sm font-semibold text-white">Subjects</th>
              <th class="px-4 py-3 text-sm font-semibold text-white">Total Score</th>
              <th class="px-4 py-3 text-sm font-semibold text-white">Average</th>
              <th class="px-4 py-3 text-sm font-semibold text-white">Last Upload</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-white/10">
            ${studentsList.map(student => {
                const itemsSorted = student.items.slice().sort((a, b) => new Date(b.date_uploaded) - new Date(a.date_uploaded));
                const total = itemsSorted.reduce((s, it) => s + (Number(it.score) || 0), 0);
                const avg = itemsSorted.length ? Math.round((total / itemsSorted.length) * 100) / 100 : 0;
                const lastDate = itemsSorted.length ? new Date(itemsSorted[0].date_uploaded).toLocaleDateString() : '';
                const gradeMostRecent = itemsSorted.length ? (itemsSorted[0].grade_level || '') : '';

                const subjectsHtml = itemsSorted.map(it => `
                    <div class="flex items-center justify-between gap-3 py-1">
                      <div class="text-white/90 text-sm">${escapeHtml(it.subject)}</div>
                      <div class="text-white text-sm">${it.score}/100</div>
                      <div>
                        <span class="px-2 py-0.5 rounded-full text-xs font-semibold ${it.status === 'Pass' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}">
                          ${it.status}
                        </span>
                      </div>
                    </div>
                `).join('');

                return `
                  <tr>
                    <td class="px-4 py-3 text-white font-semibold">${escapeHtml(student.student_id)}</td>
                    <td class="px-4 py-3 text-white/90">${escapeHtml(student.student_name)}</td>
                    <td class="px-4 py-3 text-white/90">${escapeHtml(gradeMostRecent)}</td>
                    <td class="px-4 py-3">
                      <div class="bg-white/5 rounded-md p-2">
                        ${subjectsHtml}
                      </div>
                    </td>
                    <td class="px-4 py-3 text-white">${total}</td>
                    <td class="px-4 py-3 text-white">${avg}</td>
                    <td class="px-4 py-3 text-white/80">${lastDate}</td>
                  </tr>
                `;
            }).join('')}
          </tbody>
        </table>
      </div>
    `;
}

// --- Demo helper (Run it) ---
function seedDemo() {
    if (students.length || results.length) return;
    setSubjects(FULL_SUBJECTS);

    students.push({ student_id: 'S001', student_name: 'Alice Johnson', password_hash: '' });
    students.push({ student_id: 'S002', student_name: 'Bob Smith', password_hash: '' });
    students.push({ student_id: 'S003', student_name: 'Carol Lee', password_hash: '' });

    results.push({
        student_id: 'S001',
        student_name: 'Alice Johnson',
        subject: 'Mathematics',
        score: 92,
        status: 'Pass',
        teacher_name: 'Mr. Demo',
        date_uploaded: new Date(Date.now() - 1000 * 60 * 60 * 24 * 5).toISOString(),
        grade_level: '10th'
    });
    results.push({
        student_id: 'S001',
        student_name: 'Alice Johnson',
        subject: 'English',
        score: 85,
        status: 'Pass',
        teacher_name: 'Mr. Demo',
        date_uploaded: new Date(Date.now() - 1000 * 60 * 60 * 24 * 3).toISOString(),
        grade_level: '10th'
    });
    results.push({
        student_id: 'S002',
        student_name: 'Bob Smith',
        subject: 'Mathematics',
        score: 68,
        status: 'Pass',
        teacher_name: 'Mrs. Teach',
        date_uploaded: new Date(Date.now() - 1000 * 60 * 60 * 24 * 2).toISOString(),
        grade_level: '9th'
    });
    results.push({
        student_id: 'S002',
        student_name: 'Bob Smith',
        subject: 'Physics',
        score: 54,
        status: 'Fail',
        teacher_name: 'Mrs. Teach',
        date_uploaded: new Date().toISOString(),
        grade_level: '9th'
    });
    results.push({
        student_id: 'S003',
        student_name: 'Carol Lee',
        subject: 'History',
        score: 77,
        status: 'Pass',
        teacher_name: 'Mr. Demo',
        date_uploaded: new Date().toISOString(),
        grade_level: '11th',
        stream: 'Social'
    });
}

// seed + open teacher (now persists)
async function seedDemoAndOpenTeacher() {
    seedDemo();
    // save demo students/results to cloud
    for (const s of students) {
      // create minimal placeholder password_hash if missing
      if (!s.password_hash) s.password_hash = '';
      await saveStudentToCloudKit(s).catch(()=>{});
    }
    for (const r of results) {
      await saveResultToCloudKit(r).catch(()=>{});
    }

    currentUser = { name: 'DemoTeacher' };
    currentUserType = 'teacher';
    document.getElementById('teacher-welcome').textContent = `Welcome, ${currentUser.name}!`;
    hideAllPages();
    document.getElementById('teacher-dashboard').classList.remove('hidden');
    updateSubjectOptionsBasedOnGradeAndStream();
    updateAllResults();
}

// --- Logout ---
function logoutStudent() {
    currentUser = null;
    currentUserType = null;
    showHome();
}
function logoutTeacher() {
    currentUser = null;
    currentUserType = null;
    showHome();
}

// --- Utilities ---
function showMessage(message, type) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white font-semibold z-50 ${
        type === 'success' ? 'bg-green-600' : 'bg-red-600'
    }`;
    messageDiv.textContent = message;
    document.body.appendChild(messageDiv);
    setTimeout(() => messageDiv.remove(), 3000);
}
function clearForm(fieldIds) {
    fieldIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });
}
function escapeHtml(str) {
    if (!str && str !== 0) return '';
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
}

// --- Local persistence fallback (keeps existing behavior) ---
(function(){
  const STORAGE_KEY = 'school_portal_v1';

  function saveDataToLocalStorage() {
    try {
      const payload = {
        students: window.students || [],
        results: window.results || []
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
    } catch (err) {
      console.error('Failed to save portal data to localStorage', err);
    }
  }

  function loadDataFromLocalStorage() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const parsed = JSON.parse(raw);
      window.students = parsed.students || [];
      window.results = parsed.results || [];
      console.info(`Loaded ${window.students.length} students and ${window.results.length} results from localStorage`);
    } catch (err) {
      console.error('Failed to load portal data from localStorage', err);
    }
  }

  function wrapAndSave(fnName) {
    const orig = window[fnName];
    if (typeof orig !== 'function') return;
    window[fnName] = function() {
      const result = orig.apply(this, arguments);
      try { saveDataToLocalStorage(); } catch (e) { console.error('Auto-save failed after', fnName, e); }
      return result;
    };
  }

  window.schoolStorage = {
    save: saveDataToLocalStorage,
    load: loadDataFromLocalStorage,
    clear: function() { localStorage.removeItem(STORAGE_KEY); window.students = []; window.results = []; console.info('Cleared school portal storage'); }
  };

  // load local storage now (as fallback)
  loadDataFromLocalStorage();

  // wrap mutators
  wrapAndSave('registerStudent');
  wrapAndSave('uploadResult');
  wrapAndSave('seedDemo');
  wrapAndSave('seedDemoAndOpenTeacher');

  window.addEventListener('beforeunload', saveDataToLocalStorage);
})();

document.addEventListener('DOMContentLoaded', initializeApp);
  </script>
  </body>
</html>