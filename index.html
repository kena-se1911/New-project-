<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>School Results Management System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.1"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 50%, #581c87 100%);
            min-height: 100%;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full">
  <div class="gradient-bg min-h-full"><!-- Navigation -->
   <nav class="glass fixed top-0 left-0 right-0 z-50 px-4 py-3">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
     <div class="flex items-center space-x-3">
      <div class="w-8 h-8 bg-white rounded-lg flex items-center justify-center">
       <svg class="w-5 h-5 text-blue-600" fill="currentColor" viewbox="0 0 20 20"><path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z" />
       </svg>
      </div>
      <div class="flex flex-col"><span id="nav-school-name" class="text-white font-bold text-lg">Excellence Academy</span> <span class="text-xs text-gray-300">Developed by Kenasa Silashi &amp; Biniam Mesfin</span>
      </div>
     </div>
     <div class="flex items-center space-x-4">
      <div id="sync-status" class="text-xs text-gray-300 hidden"><span id="sync-indicator" class="inline-block w-2 h-2 bg-green-400 rounded-full mr-1"></span> <span id="sync-text">Synced</span>
      </div><button id="demo-btn" class="text-white hover:text-gray-200 transition-colors text-sm px-3 py-1 glass rounded-lg"> Demo Mode </button> <span id="current-user" class="text-white text-sm hidden"></span> <button id="logout-btn" class="text-white hover:text-gray-200 transition-colors hidden">
       <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
       </svg></button>
     </div>
    </div>
   </nav><!-- Main Content -->
   <main class="pt-20 px-4 pb-8"><!-- Login Page -->
    <div id="login-page" class="page fade-in">
     <div class="max-w-md mx-auto">
      <div class="glass rounded-2xl p-8">
       <div class="text-center mb-8">
        <div class="w-16 h-16 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
         <svg class="w-8 h-8 text-white" fill="currentColor" viewbox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd" />
         </svg>
        </div>
        <h2 class="text-3xl font-bold text-white mb-2">School Portal Login</h2>
        <p class="text-gray-200">Access your academic records</p>
       </div><!-- Login Type Toggle -->
       <div class="flex mb-6"><button id="student-tab" class="flex-1 py-2 px-4 text-white bg-blue-600 rounded-l-lg font-semibold">Student</button> <button id="teacher-tab" class="flex-1 py-2 px-4 text-gray-300 glass rounded-r-lg font-semibold">Teacher</button>
       </div><!-- Student Login Form -->
       <form id="student-login-form" class="space-y-4">
        <div><label for="student-id" class="block text-white font-semibold mb-2">Student ID</label> <input type="text" id="student-id" class="w-full px-4 py-3 rounded-lg glass text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Enter your student ID" required>
        </div>
        <div><label for="student-password" class="block text-white font-semibold mb-2">Password</label> <input type="password" id="student-password" class="w-full px-4 py-3 rounded-lg glass text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Enter your password" required>
        </div><button type="submit" id="student-login-btn" class="w-full btn-primary text-white py-3 rounded-lg font-semibold"> <span>Sign In</span> </button>
        <div class="text-center space-y-2"><button type="button" id="show-register" class="text-blue-300 hover:text-blue-200 text-sm">Don't have an account? Register here</button>
         <div id="demo-credentials" class="text-xs text-gray-300 glass rounded-lg p-3 hidden">
          <div class="font-semibold mb-2">
           Demo Credentials:
          </div>
          <div class="space-y-1">
           <div>
            <strong>Students:</strong> STU001-STU005 / Password: demo123
           </div>
           <div>
            <strong>Teacher:</strong> admin / Password: teacher2025
           </div>
          </div>
         </div>
        </div>
       </form><!-- Teacher Login Form -->
       <form id="teacher-login-form" class="space-y-4 hidden">
        <div><label for="teacher-id" class="block text-white font-semibold mb-2">Teacher ID</label> <input type="text" id="teacher-id" class="w-full px-4 py-3 rounded-lg glass text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400" placeholder="Enter your teacher ID" required>
        </div>
        <div><label for="teacher-password" class="block text-white font-semibold mb-2">Password</label> <input type="password" id="teacher-password" class="w-full px-4 py-3 rounded-lg glass text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400" placeholder="Enter your password" required>
        </div><button type="submit" id="teacher-login-btn" class="w-full btn-success text-white py-3 rounded-lg font-semibold"> <span>Sign In</span> </button>
       </form>
       <div id="login-message" class="mt-4 p-3 rounded-lg hidden"></div>
      </div>
     </div>
    </div><!-- Student Registration Page -->
    <div id="register-page" class="page hidden">
     <div class="max-w-md mx-auto">
      <div class="glass rounded-2xl p-8">
       <div class="text-center mb-8">
        <div class="w-16 h-16 bg-gradient-to-br from-green-400 to-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
         <svg class="w-8 h-8 text-white" fill="currentColor" viewbox="0 0 20 20"><path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z" />
         </svg>
        </div>
        <h2 class="text-3xl font-bold text-white mb-2">Student Registration</h2>
        <p class="text-gray-200">Create your account to access results</p>
       </div>
       <form id="student-register-form" class="space-y-4">
        <div><label for="reg-student-id" class="block text-white font-semibold mb-2">Student ID</label> <input type="text" id="reg-student-id" class="w-full px-4 py-3 rounded-lg glass text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400" placeholder="Enter your student ID" required>
        </div>
        <div><label for="reg-student-name" class="block text-white font-semibold mb-2">Full Name</label> <input type="text" id="reg-student-name" class="w-full px-4 py-3 rounded-lg glass text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400" placeholder="Enter your full name" required>
        </div>
        <div><label for="reg-grade" class="block text-white font-semibold mb-2">Grade</label> <select id="reg-grade" class="w-full px-4 py-3 rounded-lg glass text-white focus:outline-none focus:ring-2 focus:ring-green-400" required> <option value="">Select Grade</option> <option value="9">Grade 9</option> <option value="10">Grade 10</option> <option value="11">Grade 11</option> <option value="12">Grade 12</option> </select>
        </div>
        <div id="stream-container" class="hidden"><label for="reg-stream" class="block text-white font-semibold mb-2">Stream</label> <select id="reg-stream" class="w-full px-4 py-3 rounded-lg glass text-white focus:outline-none focus:ring-2 focus:ring-green-400"> <option value="">Select Stream</option> <option value="Natural">Natural Science</option> <option value="Social">Social Science</option> </select>
        </div>
        <div><label for="reg-password" class="block text-white font-semibold mb-2">Password</label> <input type="password" id="reg-password" class="w-full px-4 py-3 rounded-lg glass text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400" placeholder="Create a password" required>
        </div>
        <div><label for="reg-confirm-password" class="block text-white font-semibold mb-2">Confirm Password</label> <input type="password" id="reg-confirm-password" class="w-full px-4 py-3 rounded-lg glass text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400" placeholder="Confirm your password" required>
        </div><button type="submit" id="register-btn" class="w-full btn-success text-white py-3 rounded-lg font-semibold"> <span>Register</span> </button>
        <div class="text-center"><button type="button" id="show-login" class="text-blue-300 hover:text-blue-200 text-sm">Already have an account? Sign in</button>
        </div>
       </form>
       <div id="register-message" class="mt-4 p-3 rounded-lg hidden"></div>
      </div>
     </div>
    </div><!-- Student Dashboard -->
    <div id="student-dashboard" class="page hidden">
     <div class="max-w-6xl mx-auto">
      <div class="mb-8">
       <h2 class="text-3xl font-bold text-white mb-2">Student Dashboard</h2>
       <p class="text-gray-200">Welcome back, <span id="student-name-display">Student</span></p>
      </div><!-- Student Info Card -->
      <div class="glass rounded-2xl p-6 mb-8">
       <h3 class="text-xl font-bold text-white mb-4">Student Information</h3>
       <div class="grid md:grid-cols-4 gap-4 text-white">
        <div><span class="text-gray-300">Student ID:</span> <span id="display-student-id" class="ml-2 font-semibold">-</span>
        </div>
        <div><span class="text-gray-300">Grade:</span> <span id="display-grade" class="ml-2 font-semibold">-</span>
        </div>
        <div><span class="text-gray-300">Stream:</span> <span id="display-stream" class="ml-2 font-semibold">-</span>
        </div>
        <div><span class="text-gray-300">Academic Year:</span> <span id="display-year" class="ml-2 font-semibold">-</span>
        </div>
       </div>
      </div><!-- Results Section -->
      <div class="glass rounded-2xl p-6">
       <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-bold text-white">Academic Results</h3>
        <div class="flex space-x-2"><select id="term-filter" class="px-3 py-2 rounded-lg glass text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-400"> <option value="">All Terms</option> </select> <select id="year-filter" class="px-3 py-2 rounded-lg glass text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-400"> <option value="">All Years</option> </select>
        </div>
       </div>
       <div id="student-results-container">
        <div class="text-center py-8">
         <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
         </svg>
         <p class="text-gray-300">No results available yet</p>
        </div>
       </div>
      </div>
     </div>
    </div><!-- Teacher Dashboard -->
    <div id="teacher-dashboard" class="page hidden">
     <div class="max-w-7xl mx-auto">
      <div class="mb-8">
       <h2 class="text-3xl font-bold text-white mb-2">Teacher Dashboard</h2>
       <p class="text-gray-200">Manage student results and academic records</p>
      </div><!-- Quick Stats -->
      <div class="grid md:grid-cols-4 gap-6 mb-8">
       <div class="glass rounded-xl p-6 text-center">
        <div class="text-3xl font-bold text-white mb-2" id="total-students">
         0
        </div>
        <div class="text-gray-300">
         Total Students
        </div>
       </div>
       <div class="glass rounded-xl p-6 text-center">
        <div class="text-3xl font-bold text-white mb-2" id="total-results">
         0
        </div>
        <div class="text-gray-300">
         Total Results
        </div>
       </div>
       <div class="glass rounded-xl p-6 text-center">
        <div class="text-3xl font-bold text-white mb-2" id="avg-score">
         0
        </div>
        <div class="text-gray-300">
         Average Score
        </div>
       </div>
       <div class="glass rounded-xl p-6 text-center">
        <div class="text-3xl font-bold text-white mb-2" id="current-term-display">
         -
        </div>
        <div class="text-gray-300">
         Current Term
        </div>
       </div>
      </div><!-- Add Result Form -->
      <div class="glass rounded-2xl p-6 mb-8">
       <h3 class="text-xl font-bold text-white mb-6">Add New Result</h3>
       <form id="add-result-form" class="grid md:grid-cols-2 lg:grid-cols-6 gap-4">
        <div><label for="result-student-id" class="block text-white font-semibold mb-2">Student ID</label> <input type="text" id="result-student-id" class="w-full px-3 py-2 rounded-lg glass text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400" placeholder="Student ID" required>
        </div>
        <div><label for="result-subject" class="block text-white font-semibold mb-2">Subject</label> <select id="result-subject" class="w-full px-3 py-2 rounded-lg glass text-white focus:outline-none focus:ring-2 focus:ring-green-400" required> <option value="">Select Subject</option> </select>
        </div>
        <div><label for="result-score" class="block text-white font-semibold mb-2">Score</label> <input type="number" id="result-score" min="0" max="100" class="w-full px-3 py-2 rounded-lg glass text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400" placeholder="Score" required>
        </div>
        <div><label for="result-term" class="block text-white font-semibold mb-2">Term</label> <select id="result-term" class="w-full px-3 py-2 rounded-lg glass text-white focus:outline-none focus:ring-2 focus:ring-green-400" required> <option value="">Select Term</option> <option value="Term 1">Term 1</option> <option value="Term 2">Term 2</option> <option value="Term 3">Term 3</option> </select>
        </div>
        <div><label for="result-year" class="block text-white font-semibold mb-2">Year</label> <input type="number" id="result-year" min="2020" max="2030" class="w-full px-3 py-2 rounded-lg glass text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400" placeholder="2024" required>
        </div>
        <div class="flex items-end"><button type="submit" id="add-result-btn" class="w-full btn-success text-white py-2 rounded-lg font-semibold"> <span>Add Result</span> </button>
        </div>
       </form>
       <div id="add-result-message" class="mt-4 p-3 rounded-lg hidden"></div>
      </div><!-- Results Management -->
      <div class="glass rounded-2xl p-6">
       <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-bold text-white">All Results</h3>
        <div class="flex space-x-2"><input type="text" id="search-student" class="px-3 py-2 rounded-lg glass text-white placeholder-gray-300 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Search by Student ID"> <select id="filter-grade" class="px-3 py-2 rounded-lg glass text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-400"> <option value="">All Grades</option> <option value="9">Grade 9</option> <option value="10">Grade 10</option> <option value="11">Grade 11</option> <option value="12">Grade 12</option> </select>
        </div>
       </div>
       <div id="teacher-results-container">
        <div class="text-center py-8">
         <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
         </svg>
         <p class="text-gray-300">No results added yet</p>
        </div>
       </div>
      </div>
     </div>
    </div><!-- Access Information Footer -->
    <div class="fixed bottom-4 right-4 glass rounded-lg p-4 max-w-sm">
     <div class="text-white text-sm">
      <div class="font-semibold mb-2">
       üåê Access Information
      </div>
      <div class="text-xs text-gray-300 space-y-1">
       <div>
        <strong>Share Link:</strong> Click "Use in a design" ‚Üí "Publish website"
       </div>
       <div>
        <strong>Students:</strong> Use demo credentials or register new accounts
       </div>
       <div>
        <strong>Teachers:</strong> admin / teacher2025
       </div>
      </div>
     </div>
    </div>
   </main>
  </div>
  <script>
        // Configuration
        const defaultConfig = {
            school_name: "Excellence Academy",
            current_year: "2024-2025",
            current_term: "Term 1"
        };

        // Subject definitions by grade and stream
        const SUBJECTS = {
            9: ["Mathematics", "English", "Physics", "Chemistry", "Biology", "History", "Geography", "Civics"],
            10: ["Mathematics", "English", "Physics", "Chemistry", "Biology", "History", "Geography", "Civics"],
            11: {
                "Natural": ["Mathematics", "English", "Physics", "Chemistry", "Biology"],
                "Social": ["Mathematics", "English", "History", "Geography", "Economics", "Civics"]
            },
            12: {
                "Natural": ["Mathematics", "English", "Physics", "Chemistry", "Biology"],
                "Social": ["Mathematics", "English", "History", "Geography", "Economics", "Civics"]
            }
        };

        // Global state
        let currentUser = null;
        let currentUserType = null;
        let allData = [];
        let sessionToken = null;
        let isCloudKitAvailable = false;
        let dataCache = new Map();
        let lastSyncTime = null;

        // Appwrite Configuration - Updated from GitHub starter
        const APPWRITE_CONFIG = {
            endpoint: 'https://nyc.cloud.appwrite.io/v1',
            projectId: 'res123ultweb',
            projectName: 'My_school_web',
            databaseId: 'school-db',
            studentsCollectionId: 'students',
            resultsCollectionId: 'results'
        };

        // Backend System Class with Appwrite Integration
        class SchoolBackendSystem {
            constructor() {
                this.appwriteAvailable = false;
                this.syncInProgress = false;
                this.appwrite = null;
                this.databases = null;
                this.initializeAppwrite();
            }

            // Initialize Appwrite SDK with real-time sync capabilities
            async initializeAppwrite() {
                try {
                    // Check if Appwrite SDK is available
                    if (typeof window.Appwrite !== 'undefined') {
                        this.appwrite = new window.Appwrite.Client()
                            .setEndpoint(APPWRITE_CONFIG.endpoint)
                            .setProject(APPWRITE_CONFIG.projectId);
                        
                        this.databases = new window.Appwrite.Databases(this.appwrite);
                        this.appwriteAvailable = true;
                        isCloudKitAvailable = true;
                        
                        console.log("Appwrite initialized successfully");
                        await this.syncWithCloud();
                        
                        // Set up real-time subscriptions
                        this.setupRealtimeSubscriptions();
                    } else {
                        console.log("Appwrite SDK not available, using localStorage as primary storage");
                        await this.loadFromLocalStorage();
                    }
                } catch (error) {
                    console.warn("Appwrite initialization failed, using localStorage fallback:", error);
                    this.appwriteAvailable = false;
                    isCloudKitAvailable = false;
                    await this.loadFromLocalStorage();
                }
            }

            // Set up real-time subscriptions for live data updates
            setupRealtimeSubscriptions() {
                if (!this.appwriteAvailable) return;

                try {
                    const client = new window.Appwrite.Client()
                        .setEndpoint(APPWRITE_CONFIG.endpoint)
                        .setProject(APPWRITE_CONFIG.projectId);

                    // Subscribe to students collection changes
                    client.subscribe(`databases.${APPWRITE_CONFIG.databaseId}.collections.${APPWRITE_CONFIG.studentsCollectionId}.documents`, response => {
                        console.log('Students collection updated:', response);
                        this.handleRealtimeUpdate(response);
                    });

                    // Subscribe to results collection changes
                    client.subscribe(`databases.${APPWRITE_CONFIG.databaseId}.collections.${APPWRITE_CONFIG.resultsCollectionId}.documents`, response => {
                        console.log('Results collection updated:', response);
                        this.handleRealtimeUpdate(response);
                    });

                    console.log("Real-time subscriptions established");
                } catch (error) {
                    console.warn("Failed to set up real-time subscriptions:", error);
                }
            }

            // Handle real-time updates from Appwrite
            async handleRealtimeUpdate(response) {
                try {
                    // Refresh data when changes occur
                    await this.syncWithCloud();
                } catch (error) {
                    console.error("Failed to handle real-time update:", error);
                }
            }

            // Real-time data synchronization with Appwrite
            async syncWithCloud() {
                if (this.syncInProgress) return;
                this.syncInProgress = true;

                try {
                    if (this.appwriteAvailable) {
                        // Sync with Appwrite
                        const localData = this.getLocalData();
                        const cloudData = await this.getAppwriteData();
                        
                        // Merge data with conflict resolution
                        const mergedData = this.mergeDataSources(localData, cloudData);
                        
                        // Update both storages
                        await this.saveToLocalStorage(mergedData);
                        await this.saveToAppwrite(mergedData);
                    } else {
                        // Fallback to localStorage only
                        const localData = this.getLocalData();
                        await this.saveToLocalStorage(localData);
                    }
                    
                    lastSyncTime = Date.now();
                    console.log("Data synchronized successfully");
                } catch (error) {
                    console.error("Sync failed:", error);
                } finally {
                    this.syncInProgress = false;
                }
            }

            // Get data from Appwrite collections
            async getAppwriteData() {
                if (!this.appwriteAvailable) return [];

                try {
                    const data = [];
                    
                    // Fetch students
                    const studentsResponse = await this.databases.listDocuments(
                        APPWRITE_CONFIG.databaseId,
                        APPWRITE_CONFIG.studentsCollectionId
                    );
                    
                    studentsResponse.documents.forEach(doc => {
                        data.push({
                            id: `student_${doc.student_id}`,
                            __backendId: doc.$id,
                            type: 'student',
                            student_id: doc.student_id,
                            name: doc.name,
                            grade: doc.grade,
                            stream: doc.stream || '',
                            password_hash: doc.password_hash,
                            salt: doc.salt,
                            created_at: doc.$createdAt,
                            updated_at: doc.$updatedAt
                        });
                    });

                    // Fetch results
                    const resultsResponse = await this.databases.listDocuments(
                        APPWRITE_CONFIG.databaseId,
                        APPWRITE_CONFIG.resultsCollectionId
                    );
                    
                    resultsResponse.documents.forEach(doc => {
                        data.push({
                            id: `result_${doc.$id}`,
                            __backendId: doc.$id,
                            type: 'result',
                            student_id: doc.student_id,
                            subject: doc.subject,
                            score: doc.score,
                            grade_letter: doc.grade_letter,
                            term: doc.term,
                            year: doc.year,
                            created_at: doc.$createdAt,
                            updated_at: doc.$updatedAt
                        });
                    });

                    return data;
                } catch (error) {
                    console.error("Failed to fetch data from Appwrite:", error);
                    return [];
                }
            }

            // Save data to Appwrite collections
            async saveToAppwrite(data) {
                if (!this.appwriteAvailable) return;

                try {
                    const students = data.filter(item => item.type === 'student');
                    const results = data.filter(item => item.type === 'result');

                    // Get existing documents to avoid duplicates
                    const existingStudents = await this.databases.listDocuments(
                        APPWRITE_CONFIG.databaseId,
                        APPWRITE_CONFIG.studentsCollectionId
                    );
                    
                    const existingResults = await this.databases.listDocuments(
                        APPWRITE_CONFIG.databaseId,
                        APPWRITE_CONFIG.resultsCollectionId
                    );

                    const existingStudentIds = new Set(existingStudents.documents.map(doc => doc.student_id));
                    const existingResultIds = new Set(existingResults.documents.map(doc => doc.$id));

                    // Create new students
                    for (const student of students) {
                        if (!existingStudentIds.has(student.student_id)) {
                            try {
                                await this.databases.createDocument(
                                    APPWRITE_CONFIG.databaseId,
                                    APPWRITE_CONFIG.studentsCollectionId,
                                    'unique()',
                                    {
                                        student_id: student.student_id,
                                        name: student.name,
                                        grade: student.grade,
                                        stream: student.stream,
                                        password_hash: student.password_hash,
                                        salt: student.salt
                                    }
                                );
                            } catch (error) {
                                console.warn("Failed to create student document:", error);
                            }
                        }
                    }

                    // Create new results
                    for (const result of results) {
                        if (result.__backendId && !existingResultIds.has(result.__backendId)) {
                            try {
                                await this.databases.createDocument(
                                    APPWRITE_CONFIG.databaseId,
                                    APPWRITE_CONFIG.resultsCollectionId,
                                    'unique()',
                                    {
                                        student_id: result.student_id,
                                        subject: result.subject,
                                        score: result.score,
                                        grade_letter: result.grade_letter,
                                        term: result.term,
                                        year: result.year
                                    }
                                );
                            } catch (error) {
                                console.warn("Failed to create result document:", error);
                            }
                        }
                    }

                    console.log("Data saved to Appwrite successfully");
                } catch (error) {
                    console.error("Failed to save data to Appwrite:", error);
                }
            }

            // Create new student in Appwrite
            async createStudentInAppwrite(studentData) {
                if (!this.appwriteAvailable) return null;

                try {
                    const response = await this.databases.createDocument(
                        APPWRITE_CONFIG.databaseId,
                        APPWRITE_CONFIG.studentsCollectionId,
                        'unique()',
                        {
                            student_id: studentData.student_id,
                            name: studentData.name,
                            grade: studentData.grade,
                            stream: studentData.stream,
                            password_hash: studentData.password_hash,
                            salt: studentData.salt
                        }
                    );
                    return response;
                } catch (error) {
                    console.error("Failed to create student in Appwrite:", error);
                    return null;
                }
            }

            // Create new result in Appwrite
            async createResultInAppwrite(resultData) {
                if (!this.appwriteAvailable) return null;

                try {
                    const response = await this.databases.createDocument(
                        APPWRITE_CONFIG.databaseId,
                        APPWRITE_CONFIG.resultsCollectionId,
                        'unique()',
                        {
                            student_id: resultData.student_id,
                            subject: resultData.subject,
                            score: resultData.score,
                            grade_letter: resultData.grade_letter,
                            term: resultData.term,
                            year: resultData.year
                        }
                    );
                    return response;
                } catch (error) {
                    console.error("Failed to create result in Appwrite:", error);
                    return null;
                }
            }

            // Delete result from Appwrite
            async deleteResultFromAppwrite(documentId) {
                if (!this.appwriteAvailable) return false;

                try {
                    await this.databases.deleteDocument(
                        APPWRITE_CONFIG.databaseId,
                        APPWRITE_CONFIG.resultsCollectionId,
                        documentId
                    );
                    return true;
                } catch (error) {
                    console.error("Failed to delete result from Appwrite:", error);
                    return false;
                }
            }

            // Load data from localStorage
            async loadFromLocalStorage() {
                try {
                    const data = localStorage.getItem('school_data');
                    return data ? JSON.parse(data) : [];
                } catch (error) {
                    console.error("Failed to load from localStorage:", error);
                    return [];
                }
            }

            // Save data to localStorage with caching
            async saveToLocalStorage(data) {
                try {
                    localStorage.setItem('school_data', JSON.stringify(data));
                    localStorage.setItem('last_sync', Date.now().toString());
                    
                    // Update cache
                    dataCache.clear();
                    data.forEach(item => {
                        dataCache.set(item.id, item);
                    });
                } catch (error) {
                    console.error("Failed to save to localStorage:", error);
                }
            }

            // Simulate CloudKit data operations
            getLocalData() {
                const data = localStorage.getItem('school_data');
                return data ? JSON.parse(data) : [];
            }

            getCloudData() {
                // Simulate cloud data - in real implementation, this would fetch from CloudKit
                const cloudData = localStorage.getItem('cloud_school_data');
                return cloudData ? JSON.parse(cloudData) : [];
            }

            async saveToCloud(data) {
                // Simulate cloud save
                localStorage.setItem('cloud_school_data', JSON.stringify(data));
            }

            // Intelligent data merging with conflict resolution
            mergeDataSources(localData, cloudData) {
                const merged = new Map();
                
                // Add local data
                localData.forEach(item => {
                    merged.set(item.id, item);
                });
                
                // Merge cloud data (cloud wins on conflicts based on updated_at)
                cloudData.forEach(cloudItem => {
                    const localItem = merged.get(cloudItem.id);
                    if (!localItem || new Date(cloudItem.updated_at) > new Date(localItem.updated_at)) {
                        merged.set(cloudItem.id, cloudItem);
                    }
                });
                
                return Array.from(merged.values());
            }

            // Efficient data caching
            getCachedData(id) {
                return dataCache.get(id);
            }

            setCachedData(id, data) {
                dataCache.set(id, data);
            }

            // Auto-sync trigger
            async triggerAutoSync() {
                if (this.cloudKitAvailable && (!lastSyncTime || Date.now() - lastSyncTime > 30000)) {
                    await this.syncWithCloud();
                }
            }

            // Password hashing with salt
            async hashPassword(password, salt = null) {
                if (!salt) {
                    salt = this.generateSalt();
                }
                
                const encoder = new TextEncoder();
                const data = encoder.encode(password + salt);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                
                return { hash: hashHex, salt };
            }

            generateSalt() {
                const array = new Uint8Array(16);
                crypto.getRandomValues(array);
                return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
            }

            // Verify password
            async verifyPassword(password, hash, salt) {
                const { hash: computedHash } = await this.hashPassword(password, salt);
                return computedHash === hash;
            }

            // Generate session token
            generateSessionToken() {
                return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            // Validate student data
            validateStudentData(data) {
                const errors = [];
                
                if (!data.student_id || data.student_id.length < 3) {
                    errors.push("Student ID must be at least 3 characters");
                }
                
                if (!data.name || data.name.length < 2) {
                    errors.push("Name must be at least 2 characters");
                }
                
                if (!data.grade || ![9, 10, 11, 12].includes(parseInt(data.grade))) {
                    errors.push("Grade must be 9, 10, 11, or 12");
                }
                
                if ([11, 12].includes(parseInt(data.grade)) && !data.stream) {
                    errors.push("Stream is required for grades 11 and 12");
                }
                
                if (!data.password || data.password.length < 6) {
                    errors.push("Password must be at least 6 characters");
                }
                
                return errors;
            }

            // Validate result data
            validateResultData(data) {
                const errors = [];
                
                if (!data.student_id) {
                    errors.push("Student ID is required");
                }
                
                if (!data.subject) {
                    errors.push("Subject is required");
                }
                
                if (data.score === undefined || data.score < 0 || data.score > 100) {
                    errors.push("Score must be between 0 and 100");
                }
                
                if (!data.term) {
                    errors.push("Term is required");
                }
                
                if (!data.year || data.year < 2020 || data.year > 2030) {
                    errors.push("Year must be between 2020 and 2030");
                }
                
                return errors;
            }

            // Calculate grade letter from score
            calculateGradeLetter(score) {
                if (score >= 90) return 'A+';
                if (score >= 80) return 'A';
                if (score >= 70) return 'B+';
                if (score >= 60) return 'B';
                if (score >= 50) return 'C+';
                if (score >= 40) return 'C';
                if (score >= 30) return 'D';
                return 'F';
            }

            // Get subjects for grade and stream
            getSubjectsForGrade(grade, stream = null) {
                const gradeNum = parseInt(grade);
                if ([9, 10].includes(gradeNum)) {
                    return SUBJECTS[gradeNum];
                } else if ([11, 12].includes(gradeNum) && stream) {
                    return SUBJECTS[gradeNum][stream] || [];
                }
                return [];
            }

            // Demo system - seed sample data
            async generateDemoData() {
                const demoData = [];
                const currentYear = new Date().getFullYear();
                
                // Create demo students
                const demoStudents = [
                    { id: 'STU001', name: 'Alice Johnson', grade: 12, stream: 'Natural' },
                    { id: 'STU002', name: 'Bob Smith', grade: 11, stream: 'Social' },
                    { id: 'STU003', name: 'Carol Davis', grade: 10, stream: '' },
                    { id: 'STU004', name: 'David Wilson', grade: 12, stream: 'Natural' },
                    { id: 'STU005', name: 'Emma Brown', grade: 11, stream: 'Social' }
                ];

                // Create student records with hashed passwords
                for (const student of demoStudents) {
                    const { hash, salt } = await this.hashPassword('demo123');
                    demoData.push({
                        id: `student_${student.id}`,
                        __backendId: `student_${student.id}`,
                        type: 'student',
                        student_id: student.id,
                        name: student.name,
                        grade: student.grade,
                        stream: student.stream,
                        password_hash: hash,
                        salt,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    });
                }

                // Create demo results
                const terms = ['Term 1', 'Term 2', 'Term 3'];
                const resultId = Date.now();
                
                demoStudents.forEach((student, studentIndex) => {
                    const subjects = this.getSubjectsForGrade(student.grade, student.stream);
                    
                    terms.forEach((term, termIndex) => {
                        subjects.forEach((subject, subjectIndex) => {
                            // Generate realistic scores
                            const baseScore = 60 + Math.random() * 35; // 60-95 range
                            const score = Math.round(baseScore);
                            
                            demoData.push({
                                id: `result_${resultId + studentIndex * 100 + termIndex * 10 + subjectIndex}`,
                                __backendId: `result_${resultId + studentIndex * 100 + termIndex * 10 + subjectIndex}`,
                                type: 'result',
                                student_id: student.id,
                                subject,
                                score,
                                grade_letter: this.calculateGradeLetter(score),
                                term,
                                year: currentYear,
                                created_at: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString(),
                                updated_at: new Date().toISOString()
                            });
                        });
                    });
                });

                return demoData;
            }

            // Initialize demo mode
            async initializeDemoMode() {
                try {
                    const existingData = await this.loadFromLocalStorage();
                    if (existingData.length === 0) {
                        const demoData = await this.generateDemoData();
                        await this.saveToLocalStorage(demoData);
                        console.log("Demo data initialized");
                        return demoData;
                    }
                    return existingData;
                } catch (error) {
                    console.error("Failed to initialize demo mode:", error);
                    return [];
                }
            }
        }

        // Initialize backend system
        const backend = new SchoolBackendSystem();

        // Enhanced data handler with state management
        const dataHandler = {
            onDataChanged(data) {
                allData = data;
                
                // Update cache
                dataCache.clear();
                data.forEach(item => {
                    dataCache.set(item.id, item);
                });
                
                // Trigger auto-sync if needed
                backend.triggerAutoSync();
                
                // Update UI with smooth transitions
                updateUI();
                
                // Update sync status indicator
                updateSyncStatus();
            }
        };

        // Initialize application with full-stack integration
        async function initializeApp() {
            try {
                // Initialize backend system first
                await backend.initializeCloudKit();
                
                // Initialize demo data if needed
                const demoData = await backend.initializeDemoMode();
                
                // Initialize Data SDK
                if (window.dataSdk) {
                    const result = await window.dataSdk.init(dataHandler);
                    if (!result.isOk) {
                        console.error("Failed to initialize data SDK");
                        // Fallback to direct data loading
                        allData = demoData;
                        updateUI();
                    }
                } else {
                    // Direct data loading if SDK not available
                    allData = demoData;
                    updateUI();
                }

                // Initialize Element SDK
                if (window.elementSdk) {
                    window.elementSdk.init({
                        defaultConfig,
                        onConfigChange: async (config) => {
                            const schoolName = config.school_name || defaultConfig.school_name;
                            const currentYear = config.current_year || defaultConfig.current_year;
                            const currentTerm = config.current_term || defaultConfig.current_term;

                            document.getElementById('nav-school-name').textContent = schoolName;
                            document.getElementById('current-term-display').textContent = currentTerm;
                            
                            // Update year in add result form
                            const yearInput = document.getElementById('result-year');
                            if (yearInput && !yearInput.value) {
                                yearInput.value = currentYear.split('-')[0];
                            }
                        },
                        mapToCapabilities: (config) => ({
                            recolorables: [],
                            borderables: [],
                            fontEditable: undefined,
                            fontSizeable: undefined
                        }),
                        mapToEditPanelValues: (config) => new Map([
                            ["school_name", config.school_name || defaultConfig.school_name],
                            ["current_year", config.current_year || defaultConfig.current_year],
                            ["current_term", config.current_term || defaultConfig.current_term]
                        ])
                    });
                }

                // Setup auto-sync interval
                setInterval(async () => {
                    await backend.triggerAutoSync();
                }, 30000); // Sync every 30 seconds

                // Load session if exists
                loadSession();
                
                // Update sync status
                updateSyncStatus();
                
                console.log("Application initialized successfully");
                
            } catch (error) {
                console.error("Failed to initialize application:", error);
                showMessage('login-message', 'Failed to initialize application. Please refresh the page.', true);
            }
        }

        // Session management
        function saveSession(user, userType, token) {
            localStorage.setItem('school_session', JSON.stringify({
                user,
                userType,
                token,
                timestamp: Date.now()
            }));
        }

        function loadSession() {
            const session = localStorage.getItem('school_session');
            if (session) {
                try {
                    const { user, userType, token, timestamp } = JSON.parse(session);
                    // Check if session is less than 24 hours old
                    if (Date.now() - timestamp < 24 * 60 * 60 * 1000) {
                        currentUser = user;
                        currentUserType = userType;
                        sessionToken = token;
                        showDashboard();
                        return;
                    }
                } catch (error) {
                    console.error("Invalid session data");
                }
            }
            clearSession();
        }

        function clearSession() {
            localStorage.removeItem('school_session');
            currentUser = null;
            currentUserType = null;
            sessionToken = null;
            document.getElementById('current-user').classList.add('hidden');
            document.getElementById('logout-btn').classList.add('hidden');
            document.getElementById('sync-status').classList.add('hidden');
            showPage('login-page');
        }

        // Sync status management
        function updateSyncStatus() {
            const syncStatus = document.getElementById('sync-status');
            const syncIndicator = document.getElementById('sync-indicator');
            const syncText = document.getElementById('sync-text');
            
            if (currentUser) {
                syncStatus.classList.remove('hidden');
                
                if (backend.appwriteAvailable) {
                    syncIndicator.className = 'inline-block w-2 h-2 bg-green-400 rounded-full mr-1';
                    syncText.textContent = 'Appwrite Synced';
                } else if (isCloudKitAvailable) {
                    syncIndicator.className = 'inline-block w-2 h-2 bg-blue-400 rounded-full mr-1';
                    syncText.textContent = 'Cloud Synced';
                } else {
                    syncIndicator.className = 'inline-block w-2 h-2 bg-yellow-400 rounded-full mr-1';
                    syncText.textContent = 'Local Only';
                }
            } else {
                syncStatus.classList.add('hidden');
            }
        }

        // Demo mode activation
        async function activateDemoMode() {
            try {
                // Clear existing data
                localStorage.removeItem('school_data');
                localStorage.removeItem('cloud_school_data');
                
                // Generate fresh demo data
                const demoData = await backend.generateDemoData();
                await backend.saveToLocalStorage(demoData);
                
                // Update UI
                if (window.dataSdk) {
                    // Trigger data refresh
                    const result = await window.dataSdk.init(dataHandler);
                    if (!result.isOk) {
                        allData = demoData;
                        updateUI();
                    }
                } else {
                    allData = demoData;
                    updateUI();
                }
                
                // Show demo credentials
                document.getElementById('demo-credentials').classList.remove('hidden');
                
                showMessage('login-message', 'Demo mode activated! Use the credentials shown below to test the system.');
                
            } catch (error) {
                console.error("Failed to activate demo mode:", error);
                showMessage('login-message', 'Failed to activate demo mode. Please try again.', true);
            }
        }

        // UI Management
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.add('hidden');
            });
            document.getElementById(pageId).classList.remove('hidden');
            document.getElementById(pageId).classList.add('fade-in');
        }

        function showMessage(elementId, message, isError = false) {
            const messageEl = document.getElementById(elementId);
            messageEl.textContent = message;
            messageEl.className = `mt-4 p-3 rounded-lg ${isError ? 'bg-red-500 bg-opacity-20 text-red-200 border border-red-400' : 'bg-green-500 bg-opacity-20 text-green-200 border border-green-400'}`;
            messageEl.classList.remove('hidden');
            setTimeout(() => messageEl.classList.add('hidden'), 5000);
        }

        function setLoading(buttonId, isLoading) {
            const button = document.getElementById(buttonId);
            if (isLoading) {
                button.disabled = true;
                button.innerHTML = '<div class="loading-spinner"></div>';
            } else {
                button.disabled = false;
                const originalText = button.dataset.originalText || 'Submit';
                button.innerHTML = `<span>${originalText}</span>`;
            }
        }

        // Authentication functions
        async function handleStudentLogin(event) {
            event.preventDefault();
            setLoading('student-login-btn', true);

            try {
                const studentId = document.getElementById('student-id').value;
                const password = document.getElementById('student-password').value;

                // Find student record
                const student = allData.find(record => 
                    record.type === 'student' && record.student_id === studentId
                );

                if (!student) {
                    showMessage('login-message', 'Student not found. Please check your Student ID.', true);
                    return;
                }

                // Verify password
                const isValid = await backend.verifyPassword(password, student.password_hash, student.salt);
                if (!isValid) {
                    showMessage('login-message', 'Invalid password. Please try again.', true);
                    return;
                }

                // Create session
                currentUser = student;
                currentUserType = 'student';
                sessionToken = backend.generateSessionToken();
                saveSession(currentUser, currentUserType, sessionToken);

                showMessage('login-message', 'Login successful!');
                setTimeout(() => showDashboard(), 1000);

            } catch (error) {
                showMessage('login-message', 'Login failed. Please try again.', true);
            } finally {
                setLoading('student-login-btn', false);
            }
        }

        async function handleTeacherLogin(event) {
            event.preventDefault();
            setLoading('teacher-login-btn', true);

            try {
                const teacherId = document.getElementById('teacher-id').value;
                const password = document.getElementById('teacher-password').value;

                // Simple teacher authentication (in production, this would be more secure)
                if (teacherId === 'admin' && password === 'teacher2025') {
                    currentUser = { teacher_id: teacherId, name: 'Administrator' };
                    currentUserType = 'teacher';
                    sessionToken = backend.generateSessionToken();
                    saveSession(currentUser, currentUserType, sessionToken);

                    showMessage('login-message', 'Login successful!');
                    setTimeout(() => showDashboard(), 1000);
                } else {
                    showMessage('login-message', 'Invalid teacher credentials.', true);
                }

            } catch (error) {
                showMessage('login-message', 'Login failed. Please try again.', true);
            } finally {
                setLoading('teacher-login-btn', false);
            }
        }

        async function handleStudentRegistration(event) {
            event.preventDefault();
            
            if (allData.length >= 999) {
                showMessage('register-message', 'Maximum limit of 999 records reached.', true);
                return;
            }

            setLoading('register-btn', true);

            try {
                const studentId = document.getElementById('reg-student-id').value;
                const name = document.getElementById('reg-student-name').value;
                const grade = parseInt(document.getElementById('reg-grade').value);
                const stream = document.getElementById('reg-stream').value;
                const password = document.getElementById('reg-password').value;
                const confirmPassword = document.getElementById('reg-confirm-password').value;

                // Validate passwords match
                if (password !== confirmPassword) {
                    showMessage('register-message', 'Passwords do not match.', true);
                    return;
                }

                // Validate student data
                const validationErrors = backend.validateStudentData({
                    student_id: studentId,
                    name,
                    grade,
                    stream,
                    password
                });

                if (validationErrors.length > 0) {
                    showMessage('register-message', validationErrors.join(', '), true);
                    return;
                }

                // Check if student already exists
                const existingStudent = allData.find(record => 
                    record.type === 'student' && record.student_id === studentId
                );

                if (existingStudent) {
                    showMessage('register-message', 'Student ID already exists.', true);
                    return;
                }

                // Hash password
                const { hash, salt } = await backend.hashPassword(password);

                // Create student record
                const studentData = {
                    id: `student_${Date.now()}`,
                    type: 'student',
                    student_id: studentId,
                    name,
                    grade,
                    stream: [11, 12].includes(grade) ? stream : '',
                    password_hash: hash,
                    salt,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };

                // Try Appwrite first, then fallback to Data SDK, then localStorage
                let success = false;
                
                if (backend.appwriteAvailable) {
                    const appwriteResult = await backend.createStudentInAppwrite(studentData);
                    if (appwriteResult) {
                        success = true;
                        // Update local data
                        studentData.__backendId = appwriteResult.$id;
                        allData.push(studentData);
                        await backend.saveToLocalStorage(allData);
                    }
                }
                
                if (!success && window.dataSdk) {
                    const result = await window.dataSdk.create(studentData);
                    if (result.isOk) {
                        success = true;
                        // Update local cache
                        backend.setCachedData(studentData.id, studentData);
                        
                        // Trigger sync
                        await backend.triggerAutoSync();
                    }
                }
                
                if (!success) {
                    // Fallback to direct storage
                    allData.push(studentData);
                    await backend.saveToLocalStorage(allData);
                    success = true;
                }
                
                if (success) {
                    showMessage('register-message', 'Registration successful! You can now login.');
                    setTimeout(() => showPage('login-page'), 2000);
                } else {
                    showMessage('register-message', 'Registration failed. Please try again.', true);
                }

            } catch (error) {
                showMessage('register-message', 'Registration failed. Please try again.', true);
            } finally {
                setLoading('register-btn', false);
            }
        }

        // Dashboard functions
        function showDashboard() {
            if (currentUserType === 'student') {
                showStudentDashboard();
            } else if (currentUserType === 'teacher') {
                showTeacherDashboard();
            }
            
            // Show user info in nav
            document.getElementById('current-user').textContent = currentUser.name || currentUser.student_id;
            document.getElementById('current-user').classList.remove('hidden');
            document.getElementById('logout-btn').classList.remove('hidden');
            
            // Update sync status
            updateSyncStatus();
            
            // Hide demo credentials
            document.getElementById('demo-credentials').classList.add('hidden');
        }

        function showStudentDashboard() {
            showPage('student-dashboard');
            document.getElementById('student-name-display').textContent = currentUser.name;
            document.getElementById('display-student-id').textContent = currentUser.student_id;
            document.getElementById('display-grade').textContent = `Grade ${currentUser.grade}`;
            document.getElementById('display-stream').textContent = currentUser.stream || 'N/A';
            
            // Populate filters
            populateStudentFilters();
            renderStudentResults();
        }

        function showTeacherDashboard() {
            showPage('teacher-dashboard');
            populateSubjectDropdown();
            updateTeacherStats();
            renderTeacherResults();
        }

        // Student results functions
        function populateStudentFilters() {
            const results = allData.filter(record => 
                record.type === 'result' && record.student_id === currentUser.student_id
            );

            // Populate term filter
            const terms = [...new Set(results.map(r => r.term))];
            const termFilter = document.getElementById('term-filter');
            termFilter.innerHTML = '<option value="">All Terms</option>';
            terms.forEach(term => {
                termFilter.innerHTML += `<option value="${term}">${term}</option>`;
            });

            // Populate year filter
            const years = [...new Set(results.map(r => r.year))];
            const yearFilter = document.getElementById('year-filter');
            yearFilter.innerHTML = '<option value="">All Years</option>';
            years.forEach(year => {
                yearFilter.innerHTML += `<option value="${year}">${year}</option>`;
            });
        }

        function renderStudentResults() {
            if (!currentUser) return;

            const container = document.getElementById('student-results-container');
            let results = allData.filter(record => 
                record.type === 'result' && record.student_id === currentUser.student_id
            );

            // Apply filters
            const termFilter = document.getElementById('term-filter').value;
            const yearFilter = document.getElementById('year-filter').value;

            if (termFilter) {
                results = results.filter(r => r.term === termFilter);
            }
            if (yearFilter) {
                results = results.filter(r => r.year.toString() === yearFilter);
            }

            if (results.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <p class="text-gray-300">No results available for the selected filters</p>
                    </div>
                `;
                return;
            }

            // Group results by term and year
            const groupedResults = {};
            results.forEach(result => {
                const key = `${result.year} - ${result.term}`;
                if (!groupedResults[key]) {
                    groupedResults[key] = [];
                }
                groupedResults[key].push(result);
            });

            let html = '';
            Object.keys(groupedResults).sort().reverse().forEach(key => {
                const termResults = groupedResults[key];
                const average = termResults.reduce((sum, r) => sum + r.score, 0) / termResults.length;
                const totalScore = termResults.reduce((sum, r) => sum + r.score, 0);
                const maxScore = termResults.length * 100;

                html += `
                    <div class="mb-8">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-bold text-white">${key}</h4>
                            <div class="text-right">
                                <div class="text-white font-semibold">Average: ${average.toFixed(1)}%</div>
                                <div class="text-gray-300 text-sm">Total: ${totalScore}/${maxScore}</div>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-white">
                                <thead>
                                    <tr class="border-b border-gray-600">
                                        <th class="text-left py-3 px-4">Subject</th>
                                        <th class="text-left py-3 px-4">Score</th>
                                        <th class="text-left py-3 px-4">Grade</th>
                                        <th class="text-left py-3 px-4">Date Added</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${termResults.map(result => `
                                        <tr class="border-b border-gray-700 hover:bg-white hover:bg-opacity-5">
                                            <td class="py-3 px-4 font-semibold">${result.subject}</td>
                                            <td class="py-3 px-4">${result.score}/100</td>
                                            <td class="py-3 px-4">
                                                <span class="px-2 py-1 rounded-full text-sm font-semibold ${getGradeColor(result.grade_letter)}">
                                                    ${result.grade_letter}
                                                </span>
                                            </td>
                                            <td class="py-3 px-4 text-gray-300">${new Date(result.created_at).toLocaleDateString()}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Teacher functions
        function populateSubjectDropdown() {
            const dropdown = document.getElementById('result-subject');
            dropdown.innerHTML = '<option value="">Select Subject</option>';
            
            // Get all unique subjects from all grades
            const allSubjects = new Set();
            Object.values(SUBJECTS).forEach(subjects => {
                if (Array.isArray(subjects)) {
                    subjects.forEach(subject => allSubjects.add(subject));
                } else {
                    Object.values(subjects).forEach(streamSubjects => {
                        streamSubjects.forEach(subject => allSubjects.add(subject));
                    });
                }
            });

            [...allSubjects].sort().forEach(subject => {
                dropdown.innerHTML += `<option value="${subject}">${subject}</option>`;
            });
        }

        function updateTeacherStats() {
            const students = allData.filter(record => record.type === 'student');
            const results = allData.filter(record => record.type === 'result');
            
            document.getElementById('total-students').textContent = students.length;
            document.getElementById('total-results').textContent = results.length;
            
            if (results.length > 0) {
                const avgScore = results.reduce((sum, r) => sum + r.score, 0) / results.length;
                document.getElementById('avg-score').textContent = avgScore.toFixed(1) + '%';
            } else {
                document.getElementById('avg-score').textContent = '0%';
            }
        }

        async function handleAddResult(event) {
            event.preventDefault();
            
            if (allData.length >= 999) {
                showMessage('add-result-message', 'Maximum limit of 999 records reached.', true);
                return;
            }

            setLoading('add-result-btn', true);

            try {
                const studentId = document.getElementById('result-student-id').value;
                const subject = document.getElementById('result-subject').value;
                const score = parseInt(document.getElementById('result-score').value);
                const term = document.getElementById('result-term').value;
                const year = parseInt(document.getElementById('result-year').value);

                // Validate result data
                const validationErrors = backend.validateResultData({
                    student_id: studentId,
                    subject,
                    score,
                    term,
                    year
                });

                if (validationErrors.length > 0) {
                    showMessage('add-result-message', validationErrors.join(', '), true);
                    return;
                }

                // Check if student exists
                const student = allData.find(record => 
                    record.type === 'student' && record.student_id === studentId
                );

                if (!student) {
                    showMessage('add-result-message', 'Student not found. Please check the Student ID.', true);
                    return;
                }

                // Check for duplicate result
                const existingResult = allData.find(record => 
                    record.type === 'result' && 
                    record.student_id === studentId && 
                    record.subject === subject && 
                    record.term === term && 
                    record.year === year
                );

                if (existingResult) {
                    showMessage('add-result-message', 'Result already exists for this student, subject, term, and year.', true);
                    return;
                }

                // Create result record
                const resultData = {
                    id: `result_${Date.now()}`,
                    type: 'result',
                    student_id: studentId,
                    subject,
                    score,
                    grade_letter: backend.calculateGradeLetter(score),
                    term,
                    year,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };

                // Try Appwrite first, then fallback to Data SDK, then localStorage
                let success = false;
                
                if (backend.appwriteAvailable) {
                    const appwriteResult = await backend.createResultInAppwrite(resultData);
                    if (appwriteResult) {
                        success = true;
                        // Update local data
                        resultData.__backendId = appwriteResult.$id;
                        allData.push(resultData);
                        await backend.saveToLocalStorage(allData);
                    }
                }
                
                if (!success && window.dataSdk) {
                    const result = await window.dataSdk.create(resultData);
                    if (result.isOk) {
                        success = true;
                        // Update local cache
                        backend.setCachedData(resultData.id, resultData);
                        
                        // Trigger sync
                        await backend.triggerAutoSync();
                    }
                }
                
                if (!success) {
                    // Fallback to direct storage
                    allData.push(resultData);
                    await backend.saveToLocalStorage(allData);
                    success = true;
                }
                
                if (success) {
                    document.getElementById('add-result-form').reset();
                    showMessage('add-result-message', 'Result added successfully!');
                    updateTeacherStats();
                    updateUI();
                } else {
                    showMessage('add-result-message', 'Failed to add result. Please try again.', true);
                }

            } catch (error) {
                showMessage('add-result-message', 'Failed to add result. Please try again.', true);
            } finally {
                setLoading('add-result-btn', false);
            }
        }

        function renderTeacherResults() {
            const container = document.getElementById('teacher-results-container');
            let results = allData.filter(record => record.type === 'result');

            // Apply filters
            const searchStudent = document.getElementById('search-student').value.toLowerCase();
            const filterGrade = document.getElementById('filter-grade').value;

            if (searchStudent) {
                results = results.filter(r => r.student_id.toLowerCase().includes(searchStudent));
            }

            if (filterGrade) {
                const studentsInGrade = allData.filter(record => 
                    record.type === 'student' && record.grade.toString() === filterGrade
                ).map(s => s.student_id);
                results = results.filter(r => studentsInGrade.includes(r.student_id));
            }

            if (results.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <p class="text-gray-300">No results found for the selected filters</p>
                    </div>
                `;
                return;
            }

            // Sort results by date (newest first)
            results.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            container.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full text-white">
                        <thead>
                            <tr class="border-b border-gray-600">
                                <th class="text-left py-3 px-4">Student ID</th>
                                <th class="text-left py-3 px-4">Subject</th>
                                <th class="text-left py-3 px-4">Score</th>
                                <th class="text-left py-3 px-4">Grade</th>
                                <th class="text-left py-3 px-4">Term</th>
                                <th class="text-left py-3 px-4">Year</th>
                                <th class="text-left py-3 px-4">Date Added</th>
                                <th class="text-left py-3 px-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${results.map(result => `
                                <tr class="border-b border-gray-700 hover:bg-white hover:bg-opacity-5">
                                    <td class="py-3 px-4 font-semibold">${result.student_id}</td>
                                    <td class="py-3 px-4">${result.subject}</td>
                                    <td class="py-3 px-4">${result.score}/100</td>
                                    <td class="py-3 px-4">
                                        <span class="px-2 py-1 rounded-full text-sm font-semibold ${getGradeColor(result.grade_letter)}">
                                            ${result.grade_letter}
                                        </span>
                                    </td>
                                    <td class="py-3 px-4">${result.term}</td>
                                    <td class="py-3 px-4">${result.year}</td>
                                    <td class="py-3 px-4 text-gray-300">${new Date(result.created_at).toLocaleDateString()}</td>
                                    <td class="py-3 px-4">
                                        <button onclick="deleteResult('${result.__backendId}')" class="text-red-400 hover:text-red-300 transition-colors" title="Delete Result">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                            </svg>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        async function deleteResult(backendId) {
            const result = allData.find(r => r.__backendId === backendId);
            if (!result) return;

            let success = false;

            // Try Appwrite first
            if (backend.appwriteAvailable && backendId) {
                success = await backend.deleteResultFromAppwrite(backendId);
                if (success) {
                    // Remove from local data
                    const index = allData.findIndex(r => r.__backendId === backendId);
                    if (index > -1) {
                        allData.splice(index, 1);
                        await backend.saveToLocalStorage(allData);
                    }
                }
            }

            // Fallback to Data SDK
            if (!success && window.dataSdk) {
                const deleteResult = await window.dataSdk.delete(result);
                if (deleteResult.isOk) {
                    success = true;
                }
            }

            // Fallback to local deletion
            if (!success) {
                const index = allData.findIndex(r => r.__backendId === backendId);
                if (index > -1) {
                    allData.splice(index, 1);
                    await backend.saveToLocalStorage(allData);
                    success = true;
                }
            }

            if (success) {
                updateTeacherStats();
                updateUI();
            } else {
                showMessage('add-result-message', 'Failed to delete result.', true);
            }
        }

        // Utility functions
        function getGradeColor(grade) {
            const colors = {
                'A+': 'bg-green-600 text-white',
                'A': 'bg-green-500 text-white',
                'B+': 'bg-blue-500 text-white',
                'B': 'bg-blue-400 text-white',
                'C+': 'bg-yellow-500 text-white',
                'C': 'bg-yellow-400 text-black',
                'D': 'bg-orange-500 text-white',
                'F': 'bg-red-500 text-white'
            };
            return colors[grade] || 'bg-gray-500 text-white';
        }

        function updateUI() {
            if (currentUserType === 'student') {
                populateStudentFilters();
                renderStudentResults();
            } else if (currentUserType === 'teacher') {
                updateTeacherStats();
                renderTeacherResults();
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();

            // Store original button text
            document.querySelectorAll('button[type="submit"]').forEach(btn => {
                const span = btn.querySelector('span');
                if (span) {
                    btn.dataset.originalText = span.textContent;
                }
            });

            // Login type toggle
            document.getElementById('student-tab').addEventListener('click', function() {
                this.classList.add('bg-blue-600');
                this.classList.remove('glass');
                document.getElementById('teacher-tab').classList.remove('bg-blue-600');
                document.getElementById('teacher-tab').classList.add('glass');
                document.getElementById('student-login-form').classList.remove('hidden');
                document.getElementById('teacher-login-form').classList.add('hidden');
            });

            document.getElementById('teacher-tab').addEventListener('click', function() {
                this.classList.add('bg-blue-600');
                this.classList.remove('glass');
                document.getElementById('student-tab').classList.remove('bg-blue-600');
                document.getElementById('student-tab').classList.add('glass');
                document.getElementById('teacher-login-form').classList.remove('hidden');
                document.getElementById('student-login-form').classList.add('hidden');
            });

            // Navigation
            document.getElementById('show-register').addEventListener('click', () => showPage('register-page'));
            document.getElementById('show-login').addEventListener('click', () => showPage('login-page'));
            document.getElementById('logout-btn').addEventListener('click', clearSession);
            document.getElementById('demo-btn').addEventListener('click', activateDemoMode);

            // Grade change handler for registration
            document.getElementById('reg-grade').addEventListener('change', function() {
                const grade = parseInt(this.value);
                const streamContainer = document.getElementById('stream-container');
                const streamSelect = document.getElementById('reg-stream');
                
                if ([11, 12].includes(grade)) {
                    streamContainer.classList.remove('hidden');
                    streamSelect.required = true;
                } else {
                    streamContainer.classList.add('hidden');
                    streamSelect.required = false;
                    streamSelect.value = '';
                }
            });

            // Form submissions
            document.getElementById('student-login-form').addEventListener('submit', handleStudentLogin);
            document.getElementById('teacher-login-form').addEventListener('submit', handleTeacherLogin);
            document.getElementById('student-register-form').addEventListener('submit', handleStudentRegistration);
            document.getElementById('add-result-form').addEventListener('submit', handleAddResult);

            // Filters
            document.getElementById('term-filter').addEventListener('change', renderStudentResults);
            document.getElementById('year-filter').addEventListener('change', renderStudentResults);
            document.getElementById('search-student').addEventListener('input', renderTeacherResults);
            document.getElementById('filter-grade').addEventListener('change', renderTeacherResults);
        });
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99ec1298b594d347',t:'MTc2MzE4MTY0OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>